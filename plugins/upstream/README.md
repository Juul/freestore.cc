# Note to self #

The web server (freestore.js) doesn't do any checks, it just starts saving the file to disk and adds the job to the job queue.
The job queue talks to the workers (transcoders and can run in one of two modes:

  1. Insecure: The workers read the data from disk themselves and write the data to disk on their own.
  2. Secure (default): The queue server sends the data to the workers
                       and receives zero or more streams back that it (the job queue) writes to disk.

The workers handle all processing individually.

The text below is out of date and needs updating.


# About UpStream plugins #

Plugins come in three varieties: Endpoint, transform and filter plugins.

An endpoint plugin takes an incoming stream, optionally converts it to one or more other formats and saves it to disk.
An example of an endpoint plugin is the ffmpeg plugin that handles video and converts it to webm if needed.
Endpoint plugins can either decide to be called as the stream is being received, or only when the stream completes.
For video, this means the transcoding and thumbnail generation can begin while a file is being uploaded,
though that is o

A transform plugin takes an incoming stream and outputs one or more transformed streams back to UpHandler for further processing.
An example of a transform plugin is a de-archiver or de-compressor such as for handling zip files.
A count is kept for streams, such that a faulty transform plugin cannot cause an infinite loop where the same stream is 
passed through the UpHandler again and again.

A filter plugin takes an incoming stream, inspects the data, and decides to either continue inspecting the data,
to give up inspecting the data, or to report that the stream is bad (malformed of malicious.
A filter plugin does not output any new streams, nor does it write anything to disk. 

All plugins can at any point during the stream make any of the following decicions:

* That they do not support the type of data being streamed and stop processing the stream.
* That a stream is bad (malformed or malicious).

Endpoint plugins can at any point during the stream make the additional decision:

* That they have successfully completed reception of the relevant part of the stream.

If any one plugin decides that a stream is bad, then all plugins will stop processing the stream and UpStream will inform 
the source of the stream (probably the freestore web server) that the stream was dropped, which in the case of the
freestore web server will mean that the upload is canceled and the user informed that there was a problem with the upload.
If this happens to a stream that is only one of multiple streams generated by a transform plugin (e.g. in the case of a
zip file containing multiple files) then UpHandler will both inform the source of the original and continue processing
the remaining files.

If at any point during reception of a stream (except during the first 50 KB) no endpoint plugins remain 
(because they have all decided they didn't support the type of data), then UpHandler will stop receiving the stream 
and inform the source of the stream that the stream was unsupported.

# Plugin selection #


# Performance, security and the job queue #

Unfortunately all of the nice stream handling described in previous sections is complicated by performance and 
security constraints. 

There is no guarantee that e.g. video transcoding or conversion of .mobi to .epub can always happen as fast as files 
are being received, and it is not reasonable to throttle uploads to match conversion speed. This necessitates a job queue.

Since it is likely that a production system will need multiple physical computers to handle uploading and conversion, 
or at least multiple processes to take advantage of multiple CPUs, the endpoint plugins are run as one or more separate
processes 

the job queue should be accessible over the network.

It cannot be assumed that all the various conversion plugins have been written with security in mind, 
so it makes sense that they are run as separate processes and potentiall on different computers.

WARNING: Transform plugins currently run in the same process as the web server.
This will likely changed in future versions, both for security and performance reasons.
Filter plugins also currently run in the same process as the web server, but this is not currently a problem
since the only filter plugin is the ClamAV virus scanner plugin, and all it does is communicate with the virus
scanner process over TCP or a Unix socket.



The endpoint handlers make use of the job queue and can reside on another physical machine, as long as the data is 


# Examples #


